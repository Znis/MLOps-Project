name: Deploy RAG Web Application

on:
    push:
        branches:
            - main

jobs:
    deploy:
        runs-on: ubuntu-latest
        steps:
            - name: Checkout code
              uses: actions/checkout@v6
            
            - name: Deploy via SSH
              uses: appleboy/ssh-action@v1
              with:
                  host: ${{ secrets.SERVER_HOST }}
                  username: ${{ secrets.SERVER_USER }}
                  key: ${{ secrets.SERVER_SSH_KEY }}
                  script: |
                    APP_DIR="/opt/mlops-app"
                    REPO_URL="git@github.com:Znis/MLOps-Project.git"
                    BRANCH="main"

                    if [ ! -d "$APP_DIR/.git" ]; then
                        echo "Cloning repository..."
                        git clone -b $BRANCH $REPO_URL $APP_DIR
                    fi

                    cd $APP_DIR

                    git fetch origin
                    git reset --hard origin/$BRANCH
                    git clean -fd

                    docker-compose down
                    docker-compose up -d --build
                    docker image prune -f

                    echo "Deployment complete!"
